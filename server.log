INFO:     Started server process [56045]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     127.0.0.1:32894 - "GET /docs HTTP/1.1" 200 OK
INFO:     127.0.0.1:32894 - "GET /openapi.json HTTP/1.1" 200 OK
2025-12-19 04:03:33.529 | INFO     | app.nl_parser:llm_parse:17 - LLM Parse Running
2025-12-19 04:03:33.529 | INFO     | app.nl_parser:llm_parse:19 - Client Initialized
2025-12-19 04:03:33.530 | INFO     | app.nl_parser:llm_parse:84 - prompt is :- 
        You are a Google Analytics 4 (GA4) query parsing agent.

Your task is to convert a natural-language analytics question into a
STRUCTURED, GA4-EXECUTABLE QUERY.

You MUST follow GA4 Data API semantics.

----------------------------------
INPUT
----------------------------------
Natural language query:
Give me a daily breakdown of 1 day active users, page views, users, add to cart event, and sessions for the /pricing page over the last 30 days and summarize trends.

----------------------------------
WHAT TO EXTRACT
----------------------------------

1. METRICS
- Return ONLY GA4 Data API metric names (camelCase)
- Examples:
  screenPageViews, totalUsers, activeUsers, sessions,
  engagementRate, eventCount, purchaseRevenue
- If multiple metrics are requested, include ALL of them
- DO NOT invent metrics

2. DIMENSIONS
- Return ONLY GA4 Data API dimension names
- Examples:
  date, pagePath, pageTitle, eventName, country, browser, deviceCategory
- Include time dimensions (date, week, month) when time-series is implied
- DO NOT invent dimensions

3. DATE RANGE
- Infer date range from the query
- Return as number of days (integer)
- If no range is specified, default to last 7 days

4. FILTERS (optional)
- Extract page path if mentioned (e.g. /pricing, /home)
- ONLY include exact page paths
- Do NOT infer query strings

----------------------------------
RULES (STRICT)
----------------------------------
- Output MUST be valid JSON
- DO NOT include markdown
- DO NOT include explanations
- DO NOT include extra fields
- DO NOT guess unsupported GA4 fields
- Preserve user intent as much as possible

----------------------------------
OUTPUT FORMAT (STRICT)
----------------------------------
{
  "metrics": ["screenPageViews", "totalUsers"],
  "dimensions": ["date"],
  "days": 14,
  "page_path": "/pricing"
}
If you are unsure about a metric or dimension, OMIT it rather than guessing.
        
2025-12-19 04:03:45.752 | INFO     | app.nl_parser:llm_parse:90 - Response:ChatCompletion(id='PoFEabjTCqnuseMP1OXCiAM', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='```json\n{\n  "metrics": [\n    "activeUsers",\n    "screenPageViews",\n    "totalUsers",\n    "sessions"\n  ],\n  "dimensions": [\n    "date"\n  ],\n  "days": 30,\n  "page_path": "/pricing"\n}\n```', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=None))], created=1766097214, model='gemini-2.5-pro', object='chat.completion', service_tier=None, system_fingerprint=None, usage=CompletionUsage(completion_tokens=1456, prompt_tokens=463, total_tokens=1919, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=1382, rejected_prediction_tokens=None, text_tokens=74), prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=None, text_tokens=463))) and model used is gemini-2.5-pro
2025-12-19 04:03:45.753 | INFO     | app.nl_parser:parse_query:106 - Got query response from LLM
2025-12-19 04:03:47.195 | INFO     | app.summarizer:summarize:6 - LLM Parse Running
2025-12-19 04:03:47.251 | INFO     | app.summarizer:summarize:13 - Client Initialized
2025-12-19 04:03:47.251 | INFO     | app.summarizer:summarize:66 - prompt is :- 
        You are a senior data analyst specializing in Google Analytics 4 (GA4).

Your task is to analyze GA4 report results and produce a concise, business-ready natural language summary.

You will be given:
- The original user query (natural language) : Give me a daily breakdown of 1 day active users, page views, users, add to cart event, and sessions for the /pricing page over the last 30 days and summarize trends.
- The GA4 report data (time-series and/or aggregate values): []
- The metrics, dimensions, and date range used: [['activeUsers', 'screenPageViews', 'totalUsers', 'sessions'], ['date'], ['2025-11-19', '2025-12-19']]

Your responsibilities:
1. Identify overall trends (increasing, decreasing, flat)
2. Highlight significant spikes, drops, or anomalies
3. Compare start vs end of period when time-series data exists
4. Call out notable patterns related to dimensions (e.g. page path, country, device)
5. Keep explanations factual and grounded strictly in the provided data
6. Do NOT speculate beyond the data

Constraints:
- Do NOT mention internal implementation details
- Do NOT restate raw numbers unless necessary
- Use clear, non-technical language suitable for business stakeholders
- If data is insufficient to infer trends, explicitly say so

Return STRICT JSON ONLY in the following format:

{'summary': 'High-level explanation of overall performance and trends', 'trends': [{'metric': '<metric_name>', 'direction': 'up | down | flat | mixed', 'description': 'Short explanation of how this metric changed over time'}], 'anomalies': [{'metric': '<metric_name>', 'date': '<YYYY-MM-DD or range>', 'description': 'What was unusual and why it stands out'}], 'dimension_insights': [{'dimension': '<dimension_name>', 'value': '<dimension_value>', 'description': 'Notable observation tied to this dimension'}]}

        
2025-12-19 04:03:48.697 | INFO     | app.summarizer:summarize:72 - Response:ChatCompletion(id='S4FEafmSGZ6MnesP28SVwA0', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='```json\n{\n  "summary": "The requested GA4 report data is empty. Therefore, no analysis of daily active users, page views, total users, add to cart events, or sessions for the /pricing page over the last 30 days can be performed, and no trends or anomalies can be identified.",\n  "trends": [],\n  "anomalies": [],\n  "dimension_insights": []\n}\n```', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=None))], created=1766097227, model='gemini-2.5-flash', object='chat.completion', service_tier=None, system_fingerprint=None, usage=CompletionUsage(completion_tokens=237, prompt_tokens=442, total_tokens=679, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=145, rejected_prediction_tokens=None, text_tokens=92), prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=None, text_tokens=442))) and model used is gemini-2.5-flash
INFO:     127.0.0.1:32900 - "POST /analytics/query HTTP/1.1" 200 OK
2025-12-19 04:05:43.679 | INFO     | app.nl_parser:llm_parse:17 - LLM Parse Running
2025-12-19 04:05:43.680 | INFO     | app.nl_parser:llm_parse:19 - Client Initialized
2025-12-19 04:05:43.680 | INFO     | app.nl_parser:llm_parse:84 - prompt is :- 
        You are a Google Analytics 4 (GA4) query parsing agent.

Your task is to convert a natural-language analytics question into a
STRUCTURED, GA4-EXECUTABLE QUERY.

You MUST follow GA4 Data API semantics.

----------------------------------
INPUT
----------------------------------
Natural language query:
Give me a daily breakdown of day 1 active users, eccommerce purchases, page views, users, add to cart event, and sessions for mobile users and India Country for the /pricing page over the last 30 days and summarize trends.

----------------------------------
WHAT TO EXTRACT
----------------------------------

1. METRICS
- Return ONLY GA4 Data API metric names (camelCase)
- Examples:
  screenPageViews, totalUsers, activeUsers, sessions,
  engagementRate, eventCount, purchaseRevenue
- If multiple metrics are requested, include ALL of them
- DO NOT invent metrics

2. DIMENSIONS
- Return ONLY GA4 Data API dimension names
- Examples:
  date, pagePath, pageTitle, eventName, country, browser, deviceCategory
- Include time dimensions (date, week, month) when time-series is implied
- DO NOT invent dimensions

3. DATE RANGE
- Infer date range from the query
- Return as number of days (integer)
- If no range is specified, default to last 7 days

4. FILTERS (optional)
- Extract page path if mentioned (e.g. /pricing, /home)
- ONLY include exact page paths
- Do NOT infer query strings

----------------------------------
RULES (STRICT)
----------------------------------
- Output MUST be valid JSON
- DO NOT include markdown
- DO NOT include explanations
- DO NOT include extra fields
- DO NOT guess unsupported GA4 fields
- Preserve user intent as much as possible

----------------------------------
OUTPUT FORMAT (STRICT)
----------------------------------
{
  "metrics": ["screenPageViews", "totalUsers"],
  "dimensions": ["date"],
  "days": 14,
  "page_path": "/pricing"
}
If you are unsure about a metric or dimension, OMIT it rather than guessing.
        
2025-12-19 04:05:58.471 | INFO     | app.nl_parser:llm_parse:90 - Response:ChatCompletion(id='v4FEaYDuM6nuseMP1OXCiAM', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='```json\n{\n  "metrics": [\n    "active1DayUsers",\n    "ecommercePurchases",\n    "screenPageViews",\n    "activeUsers",\n    "addToCarts",\n    "sessions"\n  ],\n  "dimensions": [\n    "date"\n  ],\n  "days": 30,\n  "page_path": "/pricing"\n}\n```', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=None))], created=1766097343, model='gemini-2.5-pro', object='chat.completion', service_tier=None, system_fingerprint=None, usage=CompletionUsage(completion_tokens=1615, prompt_tokens=474, total_tokens=2089, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=1525, rejected_prediction_tokens=None, text_tokens=90), prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=None, text_tokens=474))) and model used is gemini-2.5-pro
2025-12-19 04:05:58.472 | INFO     | app.nl_parser:parse_query:106 - Got query response from LLM
2025-12-19 04:06:01.510 | INFO     | app.summarizer:summarize:6 - LLM Parse Running
2025-12-19 04:06:01.644 | INFO     | app.summarizer:summarize:13 - Client Initialized
2025-12-19 04:06:01.644 | INFO     | app.summarizer:summarize:66 - prompt is :- 
        You are a senior data analyst specializing in Google Analytics 4 (GA4).

Your task is to analyze GA4 report results and produce a concise, business-ready natural language summary.

You will be given:
- The original user query (natural language) : Give me a daily breakdown of day 1 active users, eccommerce purchases, page views, users, add to cart event, and sessions for mobile users and India Country for the /pricing page over the last 30 days and summarize trends.
- The GA4 report data (time-series and/or aggregate values): []
- The metrics, dimensions, and date range used: [['active1DayUsers', 'ecommercePurchases', 'screenPageViews', 'activeUsers', 'addToCarts', 'sessions'], ['date'], ['2025-11-19', '2025-12-19']]

Your responsibilities:
1. Identify overall trends (increasing, decreasing, flat)
2. Highlight significant spikes, drops, or anomalies
3. Compare start vs end of period when time-series data exists
4. Call out notable patterns related to dimensions (e.g. page path, country, device)
5. Keep explanations factual and grounded strictly in the provided data
6. Do NOT speculate beyond the data

Constraints:
- Do NOT mention internal implementation details
- Do NOT restate raw numbers unless necessary
- Use clear, non-technical language suitable for business stakeholders
- If data is insufficient to infer trends, explicitly say so

Return STRICT JSON ONLY in the following format:

{'summary': 'High-level explanation of overall performance and trends', 'trends': [{'metric': '<metric_name>', 'direction': 'up | down | flat | mixed', 'description': 'Short explanation of how this metric changed over time'}], 'anomalies': [{'metric': '<metric_name>', 'date': '<YYYY-MM-DD or range>', 'description': 'What was unusual and why it stands out'}], 'dimension_insights': [{'dimension': '<dimension_name>', 'value': '<dimension_value>', 'description': 'Notable observation tied to this dimension'}]}

        
2025-12-19 04:06:04.008 | INFO     | app.summarizer:summarize:72 - Response:ChatCompletion(id='0YFEaYvTManuseMP1OXCiAM', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='```json\n{\n  "summary": "No data was returned for the specified query parameters (daily breakdown of day 1 active users, ecommerce purchases, page views, users, add to cart event, and sessions for mobile users from India visiting the /pricing page over the last 30 days). Therefore, no trends, anomalies, or dimension-specific insights can be identified or summarized.",\n  "trends": [],\n  "anomalies": [],\n  "dimension_insights": []\n}\n```', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=None))], created=1766097361, model='gemini-2.5-flash', object='chat.completion', service_tier=None, system_fingerprint=None, usage=CompletionUsage(completion_tokens=313, prompt_tokens=465, total_tokens=778, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=None, audio_tokens=None, reasoning_tokens=207, rejected_prediction_tokens=None, text_tokens=106), prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=None, text_tokens=465))) and model used is gemini-2.5-flash
INFO:     127.0.0.1:47420 - "POST /analytics/query HTTP/1.1" 200 OK
